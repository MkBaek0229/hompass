<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>

    <link href="/main.css" rel="stylesheet">
</head>
<body class="font-['GMarketSans-heavy'] mt-[10%]">
{{>layouts/header}}
<main class="max-w-[475px] mx-auto px-4 pt-4 pb-28">
    <section aria-label="사용자 연령 선택 페이지">
        <div class="px-2 py-6">
            <h1 class="text-[24px] leading-tight">현재 사용자의<br> 영양 섭취 목표는 무엇인가요?</h1>
        </div>


        <form action="/choice/choice_menu" method="post">
        {{#isChoiceMenu1}}
            <button name="option" value="1번선택지" class="mt-8 w-full py-1 rounded-2xl bg-green-400 text-white flex items-center items-center gap-2 border border-solid border-gray shadow-xl">
                <div class="m-5 flex items-center gap-[20px]">
                    <div>
                        <img src="./images/choicePage_icon1.png" />
                    </div>
                    <div class="flex items-start flex-col">
                        <span class="text-lg">근육량 증가</span>
                        <span class="text-sm">벌크업 기준 영양 섭취 분석</span>
                    </div>
                </div>
            </button>
        {{/isChoiceMenu1}}
        {{^isChoiceMenu1}}

            <button name="option" value="1번선택지" class="mt-8 w-full py-1 rounded-2xl hover:bg-green-400 hover:text-white flex items-center items-center gap-2 border border-solid border-gray shadow-xl">
                    <div class="m-5 flex items-center gap-[20px]">
                        <div>
                            <img src="./images/choicePage_icon1.png" />
                        </div>
                        <div class="flex items-start flex-col">
                            <span class="text-lg">근육량 증가</span>
                            <span class="text-sm">벌크업 기준 영양 섭취 분석</span>
                        </div>
                    </div>
            </button>
        {{/isChoiceMenu1}}
        </form>

        <form action="/choice/choice_menu" method="post">
        {{#isChoiceMenu2}}
            <button name="option" value="2번선택지" class="mt-8 w-full py-1 rounded-2xl bg-green-400 text-white flex items-center items-center gap-2 border border-solid border-gray shadow-xl">
                <div class="m-5 flex items-center gap-[20px]">
                    <div>
                        <img src="./images/choicePage_icon2.png" />
                    </div>
                    <div class="flex items-start flex-col">
                        <span class="text-lg">생활형 섭취</span>
                        <span class="text-sm">평균 권장량 기준 탄단지 섭취 분석</span>
                    </div>
                </div>
            </button>
        {{/isChoiceMenu2}}
        {{^isChoiceMenu2}}
            <button name="option" value="2번선택지" class="mt-8 w-full py-1 rounded-2xl hover:bg-green-400 hover:text-white flex items-center items-center gap-2 border border-solid border-gray shadow-xl">
                <div class="m-5 flex items-center gap-[20px]">
                    <div>
                        <img src="./images/choicePage_icon2.png" />
                    </div>
                    <div class="flex items-start flex-col">
                        <span class="text-lg">생활형 섭취</span>
                        <span class="text-sm">평균 권장량 기준 탄단지 섭취 분석</span>
                    </div>
                </div>
            </button>
        {{/isChoiceMenu2}}
            {{#isChoiceMenu3}}
                <button name="option" value="3번선택지" class="mt-8 w-full py-1 rounded-2xl bg-green-400 text-white flex items-center items-center gap-2 border border-solid border-gray shadow-xl">
                    <div class="m-5 flex items-center gap-[20px]">
                        <div>
                            <img src="./images/choicePage_icon3.png" />
                        </div>
                        <div class="flex items-start flex-col">
                            <span class="text-lg">다이어트</span>
                            <span class="text-sm">다이어트 기준 탄단지 섭취 분석</span>
                        </div>
                    </div>
                </button>
            {{/isChoiceMenu3}}
            {{^isChoiceMenu3}}
                <button name="option" value="3번선택지" class="mt-8 w-full py-1 rounded-2xl hover:bg-green-400 hover:text-white flex items-center items-center gap-2 border border-solid border-gray shadow-xl">
                    <div class="m-5 flex items-center gap-[20px]">
                        <div>
                            <img src="./images/choicePage_icon3.png" />
                        </div>
                        <div class="flex items-start flex-col">
                            <span class="text-lg">다이어트</span>
                            <span class="text-sm">다이어트 기준 탄단지 섭취 분석</span>
                        </div>
                    </div>
                </button>
            {{/isChoiceMenu3}}

        </form>







    </section>
</main>
{{>layouts/footer}}
</body>
<script>
    (function () {
      const btn = document.querySelector("#start-diagnosis-btn");

      if (!btn) return;
      const selectedMenu = btn.getAttribute("data-selected");

      const mealGoalsMap = {
        "1번선택지": 0.8, // 근육량 증가
        "2번선택지": 1.0, // 생활형 섭취
        "3번선택지": 1.2  // 다이어트
      };

      btn.addEventListener("click", async () => {
      console.log("hi");
        const draftRaw = localStorage.getItem("draft_users");
        if (!draftRaw) {
          alert("먼저 BMI 정보를 입력해주세요.");
          window.location.href = "/user"; // BMI 입력 페이지 경로로 맞춰줘
          return;
        }

        let draft;
        try {
          draft = JSON.parse(draftRaw);
        } catch (e) {
          console.error("draft parse error", e);
          alert("임시 저장 데이터가 손상되었습니다. 다시 입력해주세요.");
          localStorage.removeItem("draft_users");
          window.location.href = "/user";
          return;
        }

        const payload = {
          ...draft,
          meal_goals: mealGoalsMap[selectedMenu] ?? null
        };

        try {
          const res = await fetch("/api/user", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const txt = await res.text().catch(() => "");
            console.error("save failed", res.status, txt);
            alert("저장에 실패했습니다. 잠시 후 다시 시도해주세요.");
            return;
          }

          localStorage.removeItem("draft_users");
          window.location.href = "/check";
        } catch (err) {
          console.error(err);
          alert("네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.");
        }
      });
    })();
</script>


</html>